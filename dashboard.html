<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>MapMonkey Dashboard</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f0f2f8;
        --fg: #1f2633;
        --card-bg: #ffffff;
        --accent: #3153d1;
        --accent-soft: #e7ecff;
        --muted: #6b778c;
        --border: #d8deeb;
        --error: #de4f4f;
        --warning: #f7b955;
        --success: #31b57c;
      }
      *, *::before, *::after {
        box-sizing: border-box;
      }
      body {
        font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        background: var(--bg);
        color: var(--fg);
      }
      header {
        padding: 28px 48px 32px;
        background: linear-gradient(135deg, #212b45, #284a97);
        color: #fff;
        box-shadow: 0 10px 30px rgba(12, 25, 55, 0.35);
      }
      header h1 {
        margin: 0 0 6px;
        font-size: 32px;
        letter-spacing: -0.02em;
      }
      header p {
        margin: 0;
        font-size: 15px;
        opacity: 0.82;
        letter-spacing: 0.03em;
      }
      main {
        padding: 36px 48px 48px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
      }
      .card {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 18px 40px rgba(22, 30, 61, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.6);
      }
      .card h2 {
        margin: 0 0 18px;
        font-size: 17px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--muted);
      }
      .progress-bar {
        position: relative;
        height: 12px;
        border-radius: 6px;
        background: var(--accent-soft);
        overflow: hidden;
        margin-top: 10px;
      }
      .progress-bar span {
        display: block;
        height: 100%;
        background: linear-gradient(135deg, #3f81f5, #1c92d2);
        transition: width 0.3s ease;
      }
      .progress-label {
        margin-top: 8px;
        font-size: 14px;
        color: var(--muted);
        letter-spacing: 0.02em;
      }
      .workers-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        max-height: 320px;
        overflow-y: auto;
      }
      .worker-item {
        background: rgba(236, 240, 255, 0.6);
        border-radius: 12px;
        padding: 14px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        border: 1px solid var(--border);
        font-size: 14px;
        letter-spacing: 0.01em;
      }
      .worker-item:nth-child(odd) {
        background: rgba(244, 246, 255, 0.9);
      }
      .worker-item.stuck {
        border-color: var(--error);
        box-shadow: inset 3px 0 0 var(--error);
      }
      .worker-item.missing {
        border-color: var(--warning);
        box-shadow: inset 3px 0 0 var(--warning);
        background: rgba(247, 185, 85, 0.12);
      }
      .worker-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--fg);
      }
      .worker-meta {
        color: var(--muted);
        font-size: 13px;
        white-space: nowrap;
      }
      .status-badge {
        padding: 3px 10px;
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.05em;
        text-transform: uppercase;
      }
      .worker-item.stuck .status-badge {
        background: rgba(222, 79, 79, 0.12);
        color: var(--error);
      }
      .worker-item.missing .status-badge {
        background: rgba(247, 185, 85, 0.18);
        color: #7a5111;
      }
      .alert-list {
        list-style: none;
        padding: 0;
        margin: 0;
        max-height: 240px;
        overflow-y: auto;
      }
      .alert-item {
        padding: 10px 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
      }
      .alert-item strong {
        letter-spacing: 0.08em;
      }
      .alert-item.warning {
        background: rgba(247, 185, 85, 0.18);
        color: #7a5111;
      }
      .alert-item.error {
        background: rgba(222, 79, 79, 0.16);
        color: #7a1a1a;
      }
      .alert-item.info {
        background: rgba(49, 133, 178, 0.18);
        color: #1c4f69;
      }
      .metric-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 12px;
        margin-top: 15px;
      }
      .metric {
        background: rgba(235, 239, 255, 0.6);
        padding: 14px 16px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.5;
      }
      .metric-title {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
        margin-bottom: 6px;
      }
      .metric-value {
        font-size: 20px;
        font-weight: 600;
        color: var(--fg);
      }
      .metric-body {
        white-space: pre-line;
        color: var(--fg);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th, td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      th {
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.06em;
      }
      tbody tr:nth-child(even) {
        background: rgba(235, 239, 255, 0.4);
      }
      tbody tr:hover {
        background: rgba(63, 129, 245, 0.08);
      }
      tbody tr:first-child td {
        font-weight: 600;
        color: var(--fg);
      }
      .timestamp {
        font-size: 12px;
        color: var(--muted);
      }
      @media (max-width: 720px) {
        header {
          padding: 24px 28px;
        }
        main {
          padding: 28px;
        }
        .worker-item {
          flex-direction: column;
          align-items: flex-start;
        }
        .worker-meta {
          white-space: normal;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>MapMonkey Control Panel</h1>
      <p id="overall-subtitle">Loading run metrics…</p>
    </header>
    <main>
      <section class="grid">
        <article class="card" id="overall-card">
          <h2>Overall Progress</h2>
          <div class="progress-bar"><span id="overall-progress"></span></div>
          <div class="progress-label" id="overall-label"></div>
          <div class="progress-label" id="overall-breakdown"></div>
        </article>

        <article class="card">
          <h2>Batch Progress</h2>
          <div class="progress-bar"><span id="batch-progress"></span></div>
          <div class="progress-label" id="batch-label"></div>
          <div class="progress-label" id="db-stats"></div>
        </article>

        <article class="card">
          <h2>Metrics</h2>
          <div class="metric-group" id="metrics-summary"></div>
        </article>
      </section>

      <section class="grid" style="margin-top: 25px;">
        <article class="card">
          <h2>Active Workers</h2>
          <div class="workers-list" id="workers"></div>
        </article>

        <article class="card">
          <h2>Alerts &amp; Events</h2>
          <ul class="alert-list" id="alerts"></ul>
        </article>

        <article class="card">
          <h2>Recent Businesses</h2>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Query</th>
              </tr>
            </thead>
            <tbody id="recent"></tbody>
          </table>
        </article>
      </section>
    </main>

    <script>
      const numberFormat = new Intl.NumberFormat();

      function updateProgress(element, percent) {
        element.style.width = `${Math.min(percent, 100)}%`;
      }

      function formatPercent(value, total) {
        if (!total) return '0%';
        return `${((value / total) * 100).toFixed(1)}%`;
      }

      function renderWorkers(workers) {
        const container = document.getElementById('workers');
        container.innerHTML = '';

        if (!workers.length) {
          const empty = document.createElement('div');
          empty.className = 'worker-item';
          empty.innerHTML = '<div class="worker-label"><span class="status-badge">Idle</span> No crawler telemetry available yet</div>';
          container.appendChild(empty);
          return;
        }

        const sorted = workers
          .slice()
          .sort((a, b) => {
            const aid = Number.parseInt(a.id, 10);
            const bid = Number.parseInt(b.id, 10);
            if (Number.isNaN(aid) && Number.isNaN(bid)) return 0;
            if (Number.isNaN(aid)) return 1;
            if (Number.isNaN(bid)) return -1;
            return aid - bid;
          });

        const numericMap = new Map();
        const extras = [];
        let maxId = 0;
        let minId = Number.POSITIVE_INFINITY;

        sorted.forEach(worker => {
          const parsed = Number.parseInt(worker.id, 10);
          if (Number.isNaN(parsed)) {
            extras.push(worker);
            return;
          }
          numericMap.set(parsed, worker);
          if (parsed > maxId) maxId = parsed;
          if (parsed < minId) minId = parsed;
        });

        const buildWorkerRow = worker => {
          const div = document.createElement('div');
          div.className = 'worker-item' + (worker.stuck ? ' stuck' : '');

          const label = document.createElement('div');
          label.className = 'worker-label';
          const labelText = document.createElement('span');
          labelText.textContent = `Crawler ${worker.id ?? '—'}`;
          const badge = document.createElement('span');
          badge.className = 'status-badge';
          badge.textContent = worker.stuck
            ? 'Stuck'
            : worker.heartbeat
            ? 'Active'
            : 'Idle';
          label.appendChild(labelText);
          label.appendChild(badge);

          const meta = document.createElement('div');
          meta.className = 'worker-meta';
          const assigned = worker.assigned_at
            ? new Date(worker.assigned_at * 1000).toLocaleTimeString()
            : 'Unassigned';
          const heartbeat = worker.heartbeat
            ? new Date(worker.heartbeat * 1000).toLocaleTimeString()
            : 'No heartbeat';
          const city = worker.city ?? 'n/a';
          const term = worker.term ?? 'n/a';
          meta.textContent = `${city} • ${term} • Assigned ${assigned} • Ping ${heartbeat}`;
          meta.title = `City: ${city}\nQuery: ${term}\nAssigned: ${assigned}\nLast heartbeat: ${heartbeat}`;

          div.appendChild(label);
          div.appendChild(meta);
          return div;
        };

        const buildMissingRow = id => {
          const div = document.createElement('div');
          div.className = 'worker-item missing';

          const label = document.createElement('div');
          label.className = 'worker-label';
          const labelText = document.createElement('span');
          labelText.textContent = `Crawler ${id}`;
          const badge = document.createElement('span');
          badge.className = 'status-badge';
          badge.textContent = 'No signal';
          label.appendChild(labelText);
          label.appendChild(badge);

          const meta = document.createElement('div');
          meta.className = 'worker-meta';
          meta.textContent = 'No data reported for this crawler ID';
          meta.title = 'No heartbeat or assignment has been received for this crawler ID.';

          div.appendChild(label);
          div.appendChild(meta);
          return div;
        };

        const startId = minId === Number.POSITIVE_INFINITY ? 1 : Math.min(1, minId);
        for (let id = startId; id <= maxId; id += 1) {
          const worker = numericMap.get(id);
          if (worker) {
            container.appendChild(buildWorkerRow(worker));
          } else {
            container.appendChild(buildMissingRow(id));
          }
        }

        extras.forEach(worker => {
          container.appendChild(buildWorkerRow(worker));
        });
      }

      function renderAlerts(alerts) {
        const list = document.getElementById('alerts');
        list.innerHTML = '';
        if (!alerts.length) {
          list.innerHTML = '<li class="alert-item info">No alerts recorded.</li>';
          return;
        }
        alerts
          .slice()
          .reverse()
          .forEach(alert => {
            const li = document.createElement('li');
            li.className = `alert-item ${alert.level || 'info'}`;
            const timestamp = alert.timestamp ? new Date(alert.timestamp * 1000).toLocaleTimeString() : '';
            li.innerHTML = `<strong>${(alert.level || 'info').toUpperCase()}</strong> — ${alert.message || ''}<div class="timestamp">${timestamp}</div>`;
            list.appendChild(li);
          });
      }

      function renderMetrics(metrics) {
        const summary = document.getElementById('metrics-summary');
        summary.innerHTML = '';
        const total = metrics?.businesses_saved ?? 0;
        const topQueries = Object.entries(metrics?.per_query || {})
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);
        const topCities = Object.entries(metrics?.per_city || {})
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3);

        const totalMetric = document.createElement('div');
        totalMetric.className = 'metric';
        totalMetric.innerHTML = `
          <div class="metric-title">Total saved</div>
          <div class="metric-value">${numberFormat.format(total)}</div>
        `;
        summary.appendChild(totalMetric);

        const queryMetric = document.createElement('div');
        queryMetric.className = 'metric';
        const queryTitle = document.createElement('div');
        queryTitle.className = 'metric-title';
        queryTitle.textContent = 'Top queries';
        const queryBody = document.createElement('div');
        queryBody.className = 'metric-body';
        queryBody.textContent = topQueries.length
          ? topQueries.map(([query, count]) => `${query}: ${numberFormat.format(count)}`).join('\n')
          : 'n/a';
        queryMetric.appendChild(queryTitle);
        queryMetric.appendChild(queryBody);
        summary.appendChild(queryMetric);

        const cityMetric = document.createElement('div');
        cityMetric.className = 'metric';
        const cityTitle = document.createElement('div');
        cityTitle.className = 'metric-title';
        cityTitle.textContent = 'Top cities';
        const cityBody = document.createElement('div');
        cityBody.className = 'metric-body';
        cityBody.textContent = topCities.length
          ? topCities.map(([city, count]) => `${city}: ${numberFormat.format(count)}`).join('\n')
          : 'n/a';
        cityMetric.appendChild(cityTitle);
        cityMetric.appendChild(cityBody);
        summary.appendChild(cityMetric);
      }

      function renderRecent(results) {
        const body = document.getElementById('recent');
        body.innerHTML = '';
        if (!results.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3;
          td.textContent = 'No records yet';
          tr.appendChild(td);
          body.appendChild(tr);
          return;
        }
        const ordered = results.slice().reverse();
        ordered.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.name || ''}</td>
            <td>${item.address || ''}</td>
            <td>${item.query || ''}</td>
          `;
          body.appendChild(tr);
        });
      }

      async function loadSummary() {
        try {
          const res = await fetch(`/api/summary?_=${Date.now()}`);
          if (!res.ok) throw new Error('Failed to fetch summary');
          const data = await res.json();
          const overall = data.overall || {};
          const batch = data.batch || {};

          const overallPercent = overall.total ? (overall.progress / overall.total) * 100 : 0;
          updateProgress(document.getElementById('overall-progress'), overallPercent);
          document.getElementById('overall-label').textContent = `${numberFormat.format(overall.progress || 0)} / ${numberFormat.format(overall.total || 0)} (${formatPercent(overall.progress || 0, overall.total || 0)})`;
          const cityIndex = overall.city_index ?? 0;
          document.getElementById('overall-breakdown').textContent = `City ${cityIndex + 1} of ${overall.total_cities || 0} • Term ${overall.term_index || 0} of ${overall.total_terms || 0}`;
          document.getElementById('overall-subtitle').textContent = overall.current_city ? `Currently scanning ${overall.current_city}` : 'Waiting for assignment…';

          const batchPercent = batch.total ? (batch.fill / batch.total) * 100 : 0;
          updateProgress(document.getElementById('batch-progress'), batchPercent);
          document.getElementById('batch-label').textContent = `Worker ${batch.worker ?? '—'} • ${numberFormat.format(batch.fill || 0)} / ${numberFormat.format(batch.total || 0)}`;

          const dbInfo = data.database || {};
          const totalText = dbInfo.total == null ? 'unavailable' : numberFormat.format(dbInfo.total);
          document.getElementById('db-stats').textContent = `Backend: ${dbInfo.storage || 'unknown'} • Rows: ${totalText}`;

          renderWorkers(data.workers || []);
          renderAlerts(data.alerts || []);
          renderMetrics(data.metrics || {});
          renderRecent(data.recent_businesses || []);
        } catch (err) {
          console.error(err);
        }
      }

      async function loadRecent() {
        try {
          const res = await fetch(`/api/recent?limit=25&_=${Date.now()}`);
          if (!res.ok) return;
          const data = await res.json();
          renderRecent(data.results || []);
        } catch (err) {
          console.error(err);
        }
      }

      function init() {
        loadSummary();
        loadRecent();
        setInterval(loadSummary, 2000);
        setInterval(loadRecent, 7000);
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
